name: STM32 Build CI

# Workflow ne zaman Ã§alÄ±ÅŸacak
on:
  push:
    branches: [ main, develop ]  # main veya develop branch'e push olunca
  pull_request:
    branches: [ main, develop ]  # main veya develop'a PR aÃ§Ä±lÄ±nca
  workflow_dispatch:  # Manuel olarak da Ã§alÄ±ÅŸtÄ±rabilirsiniz

jobs:
  build:
    name: Build STM32 Firmware
    runs-on: ubuntu-latest  # Ubuntu sanal makinesinde Ã§alÄ±ÅŸacak
    
    steps:
    # 1. Kod repository'sini klonla
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive  # Git submodule'ler varsa onlarÄ± da Ã§ek
    
    # 2. ARM GCC Toolchain'i kur
    - name: ðŸ”§ Install ARM GCC Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
    
    # 3. Toolchain versiyonunu gÃ¶ster (debug iÃ§in)
    - name: ðŸ“‹ Check Toolchain Version
      run: |
        arm-none-eabi-gcc --version
        make --version
    
    # 4. Projeyi derle (Root Makefile kullan)
    - name: ðŸ—ï¸ Build Project
      run: |
        make clean
        make -j$(nproc)  # Paralel derleme (tÃ¼m CPU core'larÄ±nÄ± kullan)
    
    # 5. Binary dosyalarÄ± oluÅŸtur ve boyutunu gÃ¶ster
    - name: ðŸ“¦ Create Binary Files
      run: |
        arm-none-eabi-size build/SKYRTOS.elf
    
    # 6. Build sonuÃ§larÄ±nÄ± artifact olarak kaydet
    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.sha }}
        path: |
          build/SKYRTOS.elf
          build/SKYRTOS.bin
          build/SKYRTOS.hex
          build/SKYRTOS.map
        retention-days: 30  # 30 gÃ¼n sakla
    
    # 7. Build bilgilerini gÃ¶ster
    - name: ðŸ“Š Display Build Info
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ Firmware size:"
        arm-none-eabi-size build/SKYRTOS.elf
        echo ""
        echo "ðŸ“ Generated files:"
        ls -lh build/*.elf build/*.bin build/*.hex 2>/dev/null || true
        echo ""
        echo "ðŸš€ SKYRTOS firmware ready for deployment!"
